<html>
    <!-- various dependencies of figure.js (mostly not needed on this page) -->
    <script src="{% static 'figure/3rdparty/jquery-1.11.1/jquery.min.js' %}"></script>
    <script src="{% static 'figure/3rdparty/underscore-1.13.1-umd-min.js' %}"></script>
    <script src="{% static 'figure/3rdparty/backbone-1.0.0.js' %}"></script>
    <script src="{% static 'figure/3rdparty/jspdf-2.4.0/jspdf.umd.min.js' %}"></script>

    <script src="{% static 'figure/figure_models.js' %}"></script>

    <script src="{% static 'figure/figure_export.js' %}"></script>


<body style="height: 100%; width: 100%">

    <div id="progressMessage" style="margin: auto; width:fit-content; padding:15%; text-align: center;">
        <h2 style="font-family: Arial, Helvetica, sans-serif;">Generating PDF...</h2>
        <img src="{% static 'figure/images/spinner_big.gif' %}"/>
    </div>

    <form id="jsonForm" style="display: none; margin: auto; width:fit-content; padding:15%; text-align: center;">
        <h2 style="font-family: Arial, Helvetica, sans-serif;">Enter figure JSON</h2>
        <textarea style="width:600px; height:300px; margin-bottom:10px"></textarea><br>
        <button type="submit">Create PDF</button>
    </form>

</body>

<script>

    const FILE_ID = {{ file_id|default_if_none:"undefined" }};
    const LENGTH_UNITS = {{ lengthUnits | safe }};

    const BASE_WEBFIGURE_URL = "{% url 'figure_index' %}";
    const WEBGATEWAYINDEX = "{% url 'webgateway' %}";
    const WEBINDEX_URL = "{% url 'webindex' %}";

    const MAX_PLANE_SIZE = 3000 * 3000;  // needed by FigureModel

    var figureExport = new FigureExport();

    function showProgress(percent) {
        console.log("Progress", percent);
        // This gets called during export, but the UI doesn't change
        // possibly because the thread is too busy with the export
        // document.getElementById("progress").value = percent;
    }

    function exportAndDisplay() {
        const pdfData = figureExport.exportPdf(showProgress);
        var embed = "<embed width='100%' height='100%' src='" + pdfData + "'/>"
        document.write(embed);
    }

    if (FILE_ID) {
        figureExport.load_from_OMERO(FILE_ID, exportAndDisplay);
    } else {
        $("#progressMessage").hide();
        $("#jsonForm").show().on("submit", function(event){
            event.preventDefault();
            var $form = $(this);
            var figure_text = $("textarea", $form).val();
            let figure_json = JSON.parse(figure_text);
            // show waiting placeholder...
            $("#jsonForm").hide();
            $("#progressMessage").show();
            figureExport.load_from_JSON(figure_json, exportAndDisplay);
        }).find("textarea").focus().select();
    }

</script>

</html>